<div class="mis-compras">

  <div class="mc-header">
    <div class="mc-title">
      <h2 *ngIf="!esAdmin">Mis compras</h2>
      <h2 *ngIf="esAdmin">Todas las compras</h2>
      <p class="mc-subtitle" *ngIf="!loading && !errorMsg">
        {{ esAdmin ? 'Vista de administraci√≥n: historial completo' : 'Tu historial de compras' }}
      </p>
    </div>
  </div>

  <!-- Estado: loading -->
  <div class="mc-state" *ngIf="loading">
    <div class="spinner"></div>
    <span>Cargando historial...</span>
  </div>

  <!-- Estado: error -->
  <div class="mc-alert mc-alert--error" *ngIf="!loading && errorMsg">
    {{ errorMsg }}
  </div>

  <!-- Estado: vac√≠o -->
  <div class="mc-alert" *ngIf="!loading && !errorMsg && compras.length === 0">
    No hay compras registradas.
  </div>

  <!-- Acorde√≥n -->
  <div class="accordion" *ngIf="!loading && !errorMsg && compras.length > 0">

    <div class="accordion-item" *ngFor="let v of compras">

      <button
        type="button"
        class="accordion-header"
        [class.is-open]="estaAbierta(v._id)"
        (click)="toggleVenta(v._id)">

        <div class="venta-left">
          <span class="badge">ID</span>
          <span class="venta-id">{{ v._id }}</span>
        </div>

        <div class="venta-right">
          <span class="pill" *ngIf="v.total != null">{{ v.total }} ‚Ç¨</span>

          <button
            *ngIf="esAdmin"
            type="button"
            class="btn-icon danger"
            title="Borrar compra"
            (click)="$event.stopPropagation(); borrarVenta(v._id)">
            üóëÔ∏è
          </button>

          <span class="chevron" [class.open]="estaAbierta(v._id)">‚åÑ</span>
        </div>
      </button>

      <div class="accordion-body" *ngIf="estaAbierta(v._id)">

        <div class="venta-resumen">
          <div class="resumen-item">
            <span class="k">Total</span>
            <span class="v">{{ v.total }} ‚Ç¨</span>
          </div>

          <div class="resumen-item">
            <span class="k">Unidades</span>
            <span class="v">{{ unidades(v) }}</span>
          </div>

          <div class="resumen-item" *ngIf="v.createdAt">
            <span class="k">Fecha</span>
            <span class="v">{{ v.createdAt | date:'short' }}</span>
          </div>

          <div class="resumen-item">
            <span class="k">Estado</span>
            <span class="v estado">{{ v.estado || 'CONFIRMADA' }}</span>
          </div>

          <div class="resumen-item" *ngIf="esAdmin">
            <span class="k">Usuario</span>
            <span class="v mono">{{ v.usuarioId || 'null' }}</span>
          </div>
        </div>

        <div class="lineas-wrap">
          <h4>Detalle</h4>

          <ul class="lineas">
            <li *ngFor="let l of v.lineas">
              <div class="linea-titulo">{{ l.titulo }}</div>
              <div class="linea-meta">
                <span>{{ l.cantidad }} x {{ l.precio }} ‚Ç¨</span>
                <span class="linea-subtotal">{{ (l.cantidad * l.precio) }} ‚Ç¨</span>
              </div>
            </li>
          </ul>
        </div>

      </div>
    </div>

  </div>
</div>
